---
// component import
import CategoryCloud from '@components/CategoryCloud.astro';
import PostHeader from '@components/PostHeader.astro';
import RelatedPosts from '@components/RelatedPosts.astro';
import MainLayout from '@layouts/MainLayout.astro';

// util imports
import { formatBlogPosts } from '@js/utils';

const { frontmatter } = Astro.props;
const { title, description, date, category, author, image, robots } =
   frontmatter;

const allPosts = await Astro.glob('../pages/blog/*.mdx');
const formattedPosts = formatBlogPosts(allPosts as [], {
   sortByDate: false,
});
const relatedPosts = formattedPosts
   .filter(
      (post) =>
         post.frontmatter.category.toLowerCase() === category.toLowerCase() &&
         post.frontmatter.title !== title,
   )
   .slice(0, 3);
---

<MainLayout {title} {description} {image} {frontmatter} {robots}>
   <PostHeader {title} {description} {date} {category} {image} {author} />
   <div class="post-content">
      <div class="content">
         <slot />
      </div>
      <div class="sidebar">
         <aside class="container" aria-label="Blog categories">
            <h2 class="h3">Blog Categories</h2>
            <CategoryCloud />
         </aside>
         {
            relatedPosts.length > 0 && (
               <aside class="container" aria-label="Related posts">
                  <h2 class="h3">Related Posts</h2>
                  <RelatedPosts {relatedPosts} />
               </aside>
            )
         }
      </div>
   </div>
</MainLayout>
