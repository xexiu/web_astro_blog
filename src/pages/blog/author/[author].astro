---
import Breadcrumbs from '@components/breadcrumbs/Breadcrumbs.astro';
import TagHeading from '@components/common/TagHeading.astro';
import Posts from '@components/postcard/Posts.astro';
import SectionContainer from '@components/section/SectionContainer.astro';
import { getCollectionFor } from '@js/server/utils';
import { getPostsFor, isUserAdmin, slugify } from '@js/utils';
import MainLayout from '@layouts/MainLayout.astro';
import { getCollection } from 'astro:content';

const cookie = Astro.request.headers.get('cookie');
const isAdmin = isUserAdmin(cookie);

export async function getStaticPaths() {
   const blogEntries = await getCollection('blog');
   const allAuthors = [
      ...new Set(blogEntries.map((post) => post.data.author).flat()),
   ];

   return allAuthors.map((author) => {
      return {
         props: { authorName: author },
         params: { author: slugify(author) }
      };
   });
}

const { authorName } = Astro.props;
const { author } = Astro.params;
const blogs = await getCollectionFor('blog', isAdmin, getCollection);
const authorPosts = getPostsFor({ propertyName: 'author', blog: blogs, property: authorName });
---

<MainLayout title={authorName}>
   <Breadcrumbs
      links={[
         { name: 'Inicio', path: '/' },
         { name: 'Blog', path: '/blog' },
         {
            name: authorName,
            path: `/blog/author/${author}`,
            linkIsActive: 'is-active',
         },
      ]}
   />
   <SectionContainer ariaLabel={`Posts by ${authorName}`}>
      <span>Publicaciones hechas por:</span>
      <TagHeading classes="post-author" tag="h1">{authorName}</TagHeading>
      <Posts entries={authorPosts} />
   </SectionContainer>
</MainLayout>

<style>
   .post-author {
      margin-bottom: 20px;
      text-transform: uppercase;
      text-align: center;
   }
</style>
